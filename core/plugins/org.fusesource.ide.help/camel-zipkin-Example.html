<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Example</title><link rel="stylesheet" type="text/css" href="eclipse_book.css"><meta name="generator" content="DocBook XSL Stylesheets V1.77.1"><link rel="home" href="index.html" title="Red Hat Fuse Tooling for Eclipse"><link rel="up" href="IDU-Components.html" title="Part&nbsp;V.&nbsp;Apache Camel Component Reference"><link rel="prev" href="camel-zipkin-Options.html" title="Options"><link rel="next" href="camel-zipkin-Mappingrules.html" title="Mapping rules"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="camel-zipkin-Example"></a>Example</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="camel-zipkin-Example.html#camel-zipkin-ServiceName">ServiceName</a></span></dt><dt><span class="section"><a href="camel-zipkin-Example.html#camel-zipkin-ClientandServerServiceMappings">Client and Server Service Mappings</a></span></dt></dl></div><p>To enable camel-zipkin you need to configure first</p><pre class="programlisting">ZipkinTracer zipkin = <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-keyword">new</strong> ZipkinTracer();
<em xmlns="http://www.w3.org/1999/xhtml" class="hl-comment" style="color: silver">// Configure a reporter, which controls how often spans are sent</em>
<em xmlns="http://www.w3.org/1999/xhtml" class="hl-comment" style="color: silver">//   (the dependency is io.zipkin.reporter2:zipkin-sender-okhttp3)</em>
sender = OkHttpSender.create(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"http://127.0.0.1:9411/api/v2/spans"</em></strong>);
zipkin.setSpanReporter(AsyncReporter.create(sender));
<em xmlns="http://www.w3.org/1999/xhtml" class="hl-comment" style="color: silver">// and then add zipkin to the CamelContext</em>
zipkin.init(camelContext);</pre><p>The configuration above will trace all incoming and outgoing
messages in Camel routes.&nbsp;</p><p>To use ZipkinTracer in XML, all you need to do is to define scribe and
zipkin tracer beans. Camel will automatically discover and use them.</p><pre class="programlisting">  <em xmlns="http://www.w3.org/1999/xhtml" class="hl-comment" style="color: silver">&lt;!-- configure how to reporter spans to a Zipkin collector
          (the dependency is io.zipkin.reporter2:zipkin-reporter-spring-beans) --&gt;</em>
  <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;bean</strong> <span xmlns="http://www.w3.org/1999/xhtml" class="hl-attribute" style="color: #F5844C">id</span>=<span xmlns="http://www.w3.org/1999/xhtml" class="hl-value" style="color: #993300">"http"</span> <span xmlns="http://www.w3.org/1999/xhtml" class="hl-attribute" style="color: #F5844C">class</span>=<span xmlns="http://www.w3.org/1999/xhtml" class="hl-value" style="color: #993300">"zipkin2.reporter.beans.AsyncReporterFactoryBean"</span><strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&gt;</strong>
    <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;property</strong> <span xmlns="http://www.w3.org/1999/xhtml" class="hl-attribute" style="color: #F5844C">name</span>=<span xmlns="http://www.w3.org/1999/xhtml" class="hl-value" style="color: #993300">"sender"</span><strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&gt;</strong>
      <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;bean</strong> <span xmlns="http://www.w3.org/1999/xhtml" class="hl-attribute" style="color: #F5844C">id</span>=<span xmlns="http://www.w3.org/1999/xhtml" class="hl-value" style="color: #993300">"sender"</span> <span xmlns="http://www.w3.org/1999/xhtml" class="hl-attribute" style="color: #F5844C">class</span>=<span xmlns="http://www.w3.org/1999/xhtml" class="hl-value" style="color: #993300">"zipkin2.reporter.beans.OkHttpSenderFactoryBean"</span><strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&gt;</strong>
        <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;property</strong> <span xmlns="http://www.w3.org/1999/xhtml" class="hl-attribute" style="color: #F5844C">name</span>=<span xmlns="http://www.w3.org/1999/xhtml" class="hl-value" style="color: #993300">"endpoint"</span> <span xmlns="http://www.w3.org/1999/xhtml" class="hl-attribute" style="color: #F5844C">value</span>=<span xmlns="http://www.w3.org/1999/xhtml" class="hl-value" style="color: #993300">"http://localhost:9411/api/v2/spans"</span><strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">/&gt;</strong>
      <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;/bean&gt;</strong>
    <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;/property&gt;</strong>
    <em xmlns="http://www.w3.org/1999/xhtml" class="hl-comment" style="color: silver">&lt;!-- wait up to half a second for any in-flight spans on close --&gt;</em>
    <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;property</strong> <span xmlns="http://www.w3.org/1999/xhtml" class="hl-attribute" style="color: #F5844C">name</span>=<span xmlns="http://www.w3.org/1999/xhtml" class="hl-value" style="color: #993300">"closeTimeout"</span> <span xmlns="http://www.w3.org/1999/xhtml" class="hl-attribute" style="color: #F5844C">value</span>=<span xmlns="http://www.w3.org/1999/xhtml" class="hl-value" style="color: #993300">"500"</span><strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">/&gt;</strong>
  <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;/bean&gt;</strong>

  <em xmlns="http://www.w3.org/1999/xhtml" class="hl-comment" style="color: silver">&lt;!-- setup zipkin tracer --&gt;</em>
  <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;bean</strong> <span xmlns="http://www.w3.org/1999/xhtml" class="hl-attribute" style="color: #F5844C">id</span>=<span xmlns="http://www.w3.org/1999/xhtml" class="hl-value" style="color: #993300">"zipkinTracer"</span> <span xmlns="http://www.w3.org/1999/xhtml" class="hl-attribute" style="color: #F5844C">class</span>=<span xmlns="http://www.w3.org/1999/xhtml" class="hl-value" style="color: #993300">"org.apache.camel.zipkin.ZipkinTracer"</span><strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&gt;</strong>
    <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;property</strong> <span xmlns="http://www.w3.org/1999/xhtml" class="hl-attribute" style="color: #F5844C">name</span>=<span xmlns="http://www.w3.org/1999/xhtml" class="hl-value" style="color: #993300">"serviceName"</span> <span xmlns="http://www.w3.org/1999/xhtml" class="hl-attribute" style="color: #F5844C">value</span>=<span xmlns="http://www.w3.org/1999/xhtml" class="hl-value" style="color: #993300">"dude"</span><strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">/&gt;</strong>
    <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;property</strong> <span xmlns="http://www.w3.org/1999/xhtml" class="hl-attribute" style="color: #F5844C">name</span>=<span xmlns="http://www.w3.org/1999/xhtml" class="hl-value" style="color: #993300">"spanReporter"</span> <span xmlns="http://www.w3.org/1999/xhtml" class="hl-attribute" style="color: #F5844C">ref</span>=<span xmlns="http://www.w3.org/1999/xhtml" class="hl-value" style="color: #993300">"http"</span><strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">/&gt;</strong>
  <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;/bean&gt;</strong></pre><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="camel-zipkin-ServiceName"></a>ServiceName</h2></div></div></div><p>However, if you want to map Camel endpoints to human friendly logical
names, you can add mappings</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">ServiceName *</li></ul></div><p>You can configure a global service name that all events will fallback
and use, such as:</p><pre class="programlisting">zipkin.setServiceName(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"invoices"</em></strong>);</pre><p>This will use the same service name for all incoming and outgoing zipkin
traces. If your application uses different services, you should map
them to more finely grained client / server service mappings</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="camel-zipkin-ClientandServerServiceMappings"></a>Client and Server Service Mappings</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">ClientServiceMappings</li><li class="listitem">ServerServiceMappings</li></ul></div><p>If your application hosts a service that others can call, you can map
the Camel route endpoint to a server service mapping. For example,
suppose your Camel application has the following route:</p><pre class="programlisting">from(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"activemq:queue:inbox"</em></strong>)
  .to(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"http:someserver/somepath"</em></strong>);</pre><p>And you want to make that as a server service, you can add the following
mapping:</p><pre class="programlisting">zipkin.addServerServiceMapping(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"activemq:queue:inbox"</em></strong>, <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"orders"</em></strong>);</pre><p>Then when a message is consumed from that inbox queue, it becomes a
zipkin server event with the service name 'orders'.</p><p>Now suppose that the call to http:someserver/somepath is also a service,
which you want to map to a client service name, which can be done as:</p><pre class="programlisting">zipkin.addClientServiceMapping(<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"http:someserver/somepath"</em></strong>, <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-string"><em style="color:red">"audit"</em></strong>);</pre><p>Then in the same Camel application you have mapped incoming and outgoing
endpoints to different zipkin service names.</p><p>You can use wildcards in the service mapping. To match all outgoing
calls to the same HTTP server you can do:</p><pre class="screen">zipkin.addClientServiceMapping("http:someserver*", "audit");</pre></div></div></body></html>